---
# Ana Task Akışı
- name: "Başlangıç Mesajı"
  ansible.builtin.debug:
    msg: "VM Oluşturma Otomasyonu Başlatılıyor - Service Desk No: {{ service_desk_no }}"

# ============================================
# ADIM 1: VM BİLGİLERİNİ BELIRLEME
# ============================================
- name: "Adım 1 - VM Bilgileri Belirleniyor"
  ansible.builtin.debug:
    msg: "Girilen parametrelere göre VM konfigürasyonu hazırlanıyor..."

# OS Type Belirleme (task parametresinden)
- name: "OS Type Belirleme - Task Parametresine Göre"
  ansible.builtin.set_fact:
    os_type: "{{ 'client' if task | lower == 'otomasyon' else 'server' }}"

- name: "Belirlenen OS Type"
  ansible.builtin.debug:
    msg: "OS Type: {{ os_type }} (Task: {{ task }})"

# Personal VM İsim Kontrolü ve Oluşturma
- name: "Personal VM mi Kontrolü"
  ansible.builtin.set_fact:
    is_personal_vm: "{{ true if (vm_name | lower == 'personal' and os_type == 'client') else false }}"

- name: "Personal VM İsim Oluşturma - Gerekli mi?"
  ansible.builtin.debug:
    msg: "{{ 'Personal VM - Otomatik isim oluşturulacak' if is_personal_vm else 'Standart VM - Girilen isim kullanılacak' }}"

# Personal VM için prefix belirleme
- name: "Personal VM Prefix ve OS Family Belirleme"
  block:
    - name: "OS Ailesi Belirleme"
      ansible.builtin.set_fact:
        temp_os_family: "{{ os_family_mapping[os] }}"

    - name: "Personal VM Prefix Belirleme"
      ansible.builtin.set_fact:
        personal_vm_prefix: "{{ 'VDI-' if temp_os_family == 'windows' else 'L-' }}{{ username | upper }}"

    - name: "Kullanılacak Prefix"
      ansible.builtin.debug:
        msg: "Personal VM Prefix: {{ personal_vm_prefix }} (OS Family: {{ temp_os_family }})"

  when: is_personal_vm | bool

# Personal VM için mevcut VM'leri kontrol et ve index bul
- name: "Personal VM - Uygun İsim Bulma (Python Script - Optimized)"
  ansible.builtin.include_tasks: find_personal_vm_name.yml
  when: is_personal_vm | bool

# Eğer personal değilse vm_name'i kullan
- name: "Final VM Adını Belirle"
  ansible.builtin.set_fact:
    final_vm_name: "{{ found_vm_name if is_personal_vm else vm_name }}"

- name: "Kullanılacak VM Adı"
  ansible.builtin.debug:
    msg: "Final VM Adı: {{ final_vm_name }}{{ ' (Personal - Index: ' + found_index | string + ')' if is_personal_vm else '' }}"

# vCenter Seçimi
- name: "vCenter Seçimi - Yerleşke ve Domain Bazlı"
  ansible.builtin.set_fact:
    selected_vcenter_name: "{{ vcenter_mapping[yerleske][domain] }}"

- name: "Seçilen vCenter Bilgileri"
  ansible.builtin.set_fact:
    selected_vcenter: "{{ vcenter_servers[selected_vcenter_name] }}"

- name: "Network Adapter Belirleme"
  ansible.builtin.set_fact:
    selected_network: "{{ network_mapping[selected_vcenter_name][domain] }}"

- name: "VM Spec Belirleme"
  ansible.builtin.set_fact:
    vm_cpu: "{{ vm_specs[vm_spec].cpu }}"
    vm_memory: "{{ vm_specs[vm_spec].memory_mb }}"
    vm_disk: "{{ vm_specs[vm_spec].disk_gb }}"

- name: "OS Template Belirleme"
  ansible.builtin.set_fact:
    vm_template: "{{ os_templates[os] }}"
    vm_guest_id: "{{ vm_settings.guest_id_mapping[os] }}"

- name: "OS Ailesi Belirleme (Windows/Linux)"
  ansible.builtin.set_fact:
    os_family: "{{ os_family_mapping[os] }}"

- name: "Network Konfigürasyon Tipi Belirleme"
  ansible.builtin.set_fact:
    network_type: "{{ 'dhcp' if os_type == 'client' else 'static' }}"

- name: "Static IP Belirleme (Eğer Server ise)"
  ansible.builtin.set_fact:
    vm_ip_address: "{{ task }}"
  when: os_type == 'server'

- name: "Domain Join Gereksinimi Kontrolü"
  ansible.builtin.set_fact:
    requires_domain_join: "{{ true if os_family == 'windows' else false }}"

- name: "OU Path Belirleme (Windows için)"
  ansible.builtin.set_fact:
    target_ou: "{{ domain_info[domain].ou_path if os_type == 'server' else domain_info[domain].ou_path_client }}"
  when: requires_domain_join | bool

- name: "Belirlenen VM Parametreleri - Özet"
  ansible.builtin.debug:
    msg:
      - "VM Adı: {{ final_vm_name }}{{ ' (Personal VM - Otomatik Oluşturuldu)' if is_personal_vm else '' }}"
      - "vCenter: {{ selected_vcenter_name }} ({{ selected_vcenter.hostname }})"
      - "Datacenter: {{ selected_vcenter.datacenter }}"
      - "Cluster: {{ selected_vcenter.cluster }}"
      - "Network: {{ selected_network }}"
      - "Template: {{ vm_template }}"
      - "CPU: {{ vm_cpu }}"
      - "Memory: {{ vm_memory }} MB"
      - "Disk: {{ vm_disk }} GB"
      - "OS Family: {{ os_family }}"
      - "OS Type: {{ os_type }}"
      - "Network Type: {{ network_type }}"
      - "Domain Join: {{ requires_domain_join }}"
      - "Service Desk No: {{ service_desk_no }}"
      - "Requested By: {{ username }}"

# ============================================
# ADIM 2: VM ADI KONTROLÜ
# ============================================
- name: "Adım 2 - VM Adı Kontrol Ediliyor"
  ansible.builtin.debug:
    msg: "vCenter ve Active Directory'de VM adı kontrol ediliyor..."

# vCenter'da VM Kontrolü
- name: "vCenter'da VM Varlık Kontrolü"
  community.vmware.vmware_guest_info:
    hostname: "{{ selected_vcenter.hostname }}"
    username: "{{ selected_vcenter.username }}"
    password: "{{ selected_vcenter.password }}"
    validate_certs: "{{ selected_vcenter.validate_certs }}"
    datacenter: "{{ selected_vcenter.datacenter }}"
    name: "{{ final_vm_name }}"
  register: vcenter_vm_check
  failed_when: false
  delegate_to: localhost

- name: "vCenter Kontrolü - VM Zaten Var mı?"
  ansible.builtin.fail:
    msg: "HATA: '{{ final_vm_name }}' isimli VM zaten vCenter'da mevcut! ({{ selected_vcenter.hostname }})"
  when: vcenter_vm_check.instance is defined

- name: "vCenter Kontrolü - Başarılı"
  ansible.builtin.debug:
    msg: "✓ vCenter kontrolü başarılı - VM adı kullanılabilir"
  when: vcenter_vm_check.instance is not defined

# Active Directory Kontrolü (Sadece Windows için)
- name: "Active Directory Kontrolü Gerekiyor mu?"
  ansible.builtin.debug:
    msg: "{{ 'Windows makine - AD kontrolü yapılacak' if requires_domain_join else 'Linux makine - AD kontrolü atlanıyor' }}"

- name: "Active Directory'de Computer Object Kontrolü (Windows için)"
  block:
    - name: "AD'de Computer Object Var mı Kontrol Et"
      ansible.windows.win_powershell:
        script: |
          $computerName = "{{ final_vm_name }}"
          try {
              $computer = Get-ADComputer -Identity $computerName -ErrorAction Stop
              Write-Output "EXISTS:$($computer.DistinguishedName)"
          } catch [Microsoft.ActiveDirectory.Management.ADIdentityNotFoundException] {
              Write-Output "NOT_FOUND"
          } catch {
              Write-Output "ERROR:$($_.Exception.Message)"
          }
      register: ad_check_result
      delegate_to: "{{ ad_query_server[domain] }}"

    - name: "AD Sorgu Sonucu"
      ansible.builtin.debug:
        var: ad_check_result.output

    - name: "AD Kontrolü - Computer Object Zaten Var mı?"
      ansible.builtin.fail:
        msg: "HATA: '{{ final_vm_name }}' isimli computer object zaten Active Directory'de mevcut!"
      when: "'EXISTS:' in ad_check_result.output[0]"

    - name: "AD Kontrolü - Başarılı"
      ansible.builtin.debug:
        msg: "✓ Active Directory kontrolü başarılı - Computer object mevcut değil"
      when: "'NOT_FOUND' in ad_check_result.output[0]"

    - name: "AD Kontrolü - Hata Var mı?"
      ansible.builtin.fail:
        msg: "HATA: AD sorgusunda hata oluştu - {{ ad_check_result.output[0] }}"
      when: "'ERROR:' in ad_check_result.output[0]"

  when: requires_domain_join | bool

- name: "Linux Makine - AD Kontrolü Atlandı"
  ansible.builtin.debug:
    msg: "✓ Linux makine olduğu için AD kontrolü yapılmadı"
  when: not requires_domain_join | bool

# Kontroller Başarılı
- name: "Tüm Kontroller Başarılı"
  ansible.builtin.debug:
    msg: "✓✓✓ Tüm ön kontroller başarılı! VM oluşturma işlemine devam edilebilir."

# Sonraki Adımlar için hazırlık
- name: "Sonraki Adıma Hazırlık"
  ansible.builtin.set_fact:
    vm_checks_passed: true
    vm_creation_config:
      name: "{{ final_vm_name }}"
      original_name: "{{ vm_name }}"
      is_personal: "{{ is_personal_vm }}"
      vcenter: "{{ selected_vcenter }}"
      vcenter_name: "{{ selected_vcenter_name }}"
      datacenter: "{{ selected_vcenter.datacenter }}"
      cluster: "{{ selected_vcenter.cluster }}"
      folder: "{{ selected_vcenter.folder }}"
      network: "{{ selected_network }}"
      template: "{{ vm_template }}"
      guest_id: "{{ vm_guest_id }}"
      cpu: "{{ vm_cpu }}"
      memory_mb: "{{ vm_memory }}"
      disk_gb: "{{ vm_disk }}"
      os_family: "{{ os_family }}"
      os_type: "{{ os_type }}"
      network_type: "{{ network_type }}"
      requires_domain_join: "{{ requires_domain_join }}"
      service_desk_no: "{{ service_desk_no }}"
      requested_by: "{{ username }}"