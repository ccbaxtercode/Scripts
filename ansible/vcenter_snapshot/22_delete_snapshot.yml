---
# roles/vcenter_snapshot/tasks/22_delete_snapshot.yml

- name: "Snapshot Sil: '{{ vm_item.key }}' üzerindeki snapshot siliniyor"
  block:
    - name: "Çalıştır: Snapshot silme işlemi"
      community.vmware.vmware_guest_snapshot:
        hostname: "{{ vm_item.value.vcenter_hostname }}"
        username: "{{ vcenter_user }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs }}"
        datacenter: "{{ vm_item.value.datacenter }}"
        name: "{{ vm_item.key }}"
        state: absent
        snapshot_name: "{{ service_desk_ticket }}"
      register: snapshot_delete_result

    - name: "Sonuç: Başarılı silme işlemini kaydet"
      ansible.builtin.set_fact:
        vm_processing_status: "{{ vm_processing_status | combine({vm_item.key: vm_item.value | combine({'status': 'success', 'message': 'Snapshot başarıyla silindi.', 'action_result': snapshot_delete_result}) }) }}"
      when: snapshot_delete_result.changed

    - name: "Sonuç: Silinecek snapshot bulunamadı"
      ansible.builtin.set_fact:
        vm_processing_status: "{{ vm_processing_status | combine({vm_item.key: vm_item.value | combine({'status': 'skipped', 'message': 'Belirtilen snapshot bulunamadığı için işlem atlandı.', 'action_result': snapshot_delete_result}) }) }}"
      when: not snapshot_delete_result.changed

  rescue:
    - name: "Hata: Snapshot silme hatasını kaydet"
      ansible.builtin.set_fact:
        vm_processing_status: "{{ vm_processing_status | combine({vm_item.key: vm_item.value | combine({'status': 'failed', 'message': 'Snapshot silinirken hata oluştu: ' ~ (snapshot_delete_result.msg | default('Bilinmeyen hata')), 'action_result': snapshot_delete_result}) }) }}"

  # Ana döngü: Sadece bulunan VM'ler için çalıştır
  loop: "{{ vm_processing_status | dict2items }}"
  loop_control:
    loop_var: vm_item
  when: vm_item.value.found