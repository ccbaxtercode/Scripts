---
# DELETE için VM işleme task'ı
# Ana playbook'tan include_tasks ile çağrılır

- name: "VM baslangic degiskenlerini ayarla"
  ansible.builtin.set_fact:
    vm_found_and_processed: false

- name: "VM vCenterlarda ara ve snapshot sil"
  when: not vm_found_and_processed
  block:
    - name: "VM bilgilerini al"
      community.vmware.vmware_guest_info:
        hostname: "{{ current_vcenter }}"
        username: "{{ vcenter_user }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs }}"
        name: "{{ current_vm_name }}"
        schema: "vsphere"
        properties: ["snapshot"]
      register: vm_info

    - name: "Snapshot varligini kontrol et"
      when: vm_info.instance is defined and vm_info.instance
      block:
        - name: "VM bulundu islem isaretle"
          ansible.builtin.set_fact:
            vm_found_and_processed: true

        - name: "Snapshot listesinde ara"
          ansible.builtin.set_fact:
            snapshot_exists: "{{ vm_info.instance.snapshots | selectattr('name', 'equalto', snapshot_name) | list | length > 0 }}"

        - name: "Snapshot bulunamadi uyarisi"
          when: not snapshot_exists
          block:
            - name: "Snapshot bulunamayan VMlere ekle"
              ansible.builtin.set_fact:
                snapshot_not_found: "{{ snapshot_not_found + [current_vm_name + ': Snapshot \"' + snapshot_name + '\" bulunamadı'] }}"
            
            - name: "Debug mevcut snapshotlari goster"
              ansible.builtin.debug:
                msg: "{{ current_vm_name }} üzerindeki mevcut snapshot'lar: {{ vm_info.instance.snapshots | map(attribute='name') | list | join(', ') }}"

        - name: "Snapshot silme islemini yurut"
          when: snapshot_exists
          community.vmware.vmware_guest_snapshot:
            hostname: "{{ current_vcenter }}"
            username: "{{ vcenter_user }}"
            password: "{{ vcenter_password }}"
            validate_certs: "{{ vcenter_validate_certs }}"
            uuid: "{{ vm_info.instance.uuid }}"
            state: absent
            snapshot_name: "{{ snapshot_name }}"
          register: deletion_result

        - name: "Silinen snapshoti raporla"
          ansible.builtin.set_fact:
            deleted_snapshots: "{{ deleted_snapshots + [current_vm_name + ' - ' + snapshot_name] }}"
          when: snapshot_exists and deletion_result.changed
  rescue:
    - name: "Hata yakalandi"
      vars:
        error_msg: "{{ ansible_failed_result.msg | default('Bilinmeyen hata') }}"
        error_type: >-
          {% if 'not find' in error_msg or 'does not exist' in error_msg %}
          VM_NOT_FOUND
          {% elif 'permission' in error_msg or 'authorized' in error_msg %}
          PERMISSION_ERROR
          {% elif 'snapshot' in error_msg and 'not found' in error_msg %}
          SNAPSHOT_NOT_FOUND
          {% elif 'connection' in error_msg or 'timeout' in error_msg %}
          CONNECTION_ERROR
          {% else %}
          UNKNOWN_ERROR
          {% endif %}
      block:
        - name: "Hata detayini logla"
          ansible.builtin.debug:
            msg: |
              ======================================
              VM: {{ current_vm_name }}
              vCenter: {{ current_vcenter }}
              Hata Tipi: {{ error_type }}
              Hata Mesajı: {{ error_msg }}
              ======================================

        - name: "VM bulunamadi durumu"
          ansible.builtin.set_fact:
            vm_not_found: "{{ vm_not_found + [current_vm_name + ' (vCenter: ' + current_vcenter + ')'] }}"
          when: error_type == 'VM_NOT_FOUND'

        - name: "Permission Connection veya diger hatalar"
          ansible.builtin.set_fact:
            deletion_errors: "{{ deletion_errors + [current_vm_name + ' - ' + error_type + ': ' + error_msg] }}"
          when: error_type != 'VM_NOT_FOUND'
  loop: "{{ vcenter_hostnames }}"
  loop_control:
    loop_var: current_vcenter