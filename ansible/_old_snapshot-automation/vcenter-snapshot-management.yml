---
# vCenter Snapshot Management Playbook
# AWX ile vCenter sanal makinelerinin snapshot yönetimi

- name: "vCenter Snapshot Management"
  hosts: localhost
  gather_facts: false
  vars:
    # Survey'dan gelen değişkenler
    server_list: "{{ server_list | default('') }}"
    domain: "{{ domain | default('production') }}"
    retention_days: "{{ retention_days | default(7) }}"
    operation: "{{ operation | default('take') }}"
    snapshot_name: "{{ snapshot_name | default('') }}"
    notification_email: "{{ notification_email | default('admin@company.com') }}"
    description: "{{ description | default('AWX tarafından oluşturulan snapshot') }}"
    
    # vCenter bağlantı bilgileri
    vcenter1:
      hostname: "vcenter1.company.com"
      username: "{{ lookup('env', 'VCENTER1_USER') }}"
      password: "{{ lookup('env', 'VCENTER1_PASS') }}"
      datacenter: "DC1"
      
    vcenter2:
      hostname: "vcenter2.company.com"
      username: "{{ lookup('env', 'VCENTER2_USER') }}"
      password: "{{ lookup('env', 'VCENTER2_PASS') }}"
      datacenter: "DC2"
    
    # Sonuç değişkenleri
    found_servers: []
    not_found_servers: []
    successful_snapshots: []
    failed_snapshots: []
    error_messages: []

  tasks:
    - name: "Sunucu listesini parse et"
      set_fact:
        server_names: "{{ server_list.split(',') | map('trim') | list }}"
      when: server_list != ""

    - name: "Sunucu sayısını kontrol et"
      fail:
        msg: "Maksimum 10 sunucu girilebilir. Girilen sunucu sayısı: {{ server_names | length }}"
      when: server_names | length > 10

    - name: "Sunucu listesi boş kontrolü"
      fail:
        msg: "En az bir sunucu adı girilmelidir"
      when: server_names | length == 0

    - name: "Her sunucu için vCenter'larda ara"
      vmware_guest_info:
        hostname: "{{ vcenter.hostname }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        name: "{{ server_name }}"
        validate_certs: false
      register: server_search_result
      ignore_errors: true
      with_nested:
        - "{{ server_names }}"
        - "{{ [vcenter1, vcenter2] }}"
      vars:
        server_name: "{{ item.0 }}"
        vcenter: "{{ item.1 }}"

    - name: "Sunucu arama sonuçlarını işle"
      set_fact:
        server_locations: "{{ server_locations | default({}) | combine({server_name: {'found': true, 'vcenter': vcenter.hostname, 'datacenter': vcenter.datacenter}}) }}"
      when: 
        - item is not failed
        - item.guest_name is defined
      loop: "{{ server_search_result.results }}"
      vars:
        server_name: "{{ item.0 }}"
        vcenter: "{{ item.1 }}"

    - name: "Bulunan sunucuları belirle"
      set_fact:
        found_servers: "{{ found_servers + [item] }}"
      when: item in server_locations
      loop: "{{ server_names }}"

    - name: "Bulunamayan sunucuları belirle"
      set_fact:
        not_found_servers: "{{ not_found_servers + [item] }}"
      when: item not in server_locations
      loop: "{{ server_names }}"

    - name: "Bulunamayan sunucular için hata mesajı oluştur"
      set_fact:
        error_messages: "{{ error_messages + ['Sunucu bulunamadı: ' + item] }}"
      loop: "{{ not_found_servers }}"
      when: not_found_servers | length > 0

    - name: "Snapshot işlemi başlat"
      include_tasks: "snapshot-operations.yml"
      when: found_servers | length > 0

    - name: "Mail bildirimi gönder"
      include_tasks: "send-notification.yml"

    - name: "Schedule oluştur (sadece take işlemi için)"
      include_tasks: "create-schedule.yml"
      when: 
        - operation == "take"
        - successful_snapshots | length > 0
