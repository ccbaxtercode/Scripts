---
- name: API Client Test SenaryolarÄ±
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Test 1: BaÅŸarÄ±lÄ± GET isteÄŸi (httpbin.org)
      debug:
        msg: "ğŸ§ª Test 1: BaÅŸarÄ±lÄ± GET isteÄŸi baÅŸlatÄ±lÄ±yor..."
      
    - name: BaÅŸarÄ±lÄ± GET testi
      environment:
        API_URL: "https://httpbin.org/get"
        API_METHOD: "GET"
        API_AUTH_TYPE: "basic"
        API_USERNAME: "test"
        API_PASSWORD: "test"
        API_TIMEOUT: "10"
        API_MAX_RETRIES: "1"
        API_VERIFY_SSL: "true"
      command: python3 "{{ playbook_dir }}/api_request.py"
      register: test1_result
      failed_when: test1_result.rc not in [0]
      ignore_errors: false

    - name: Test 1 sonucu
      debug:
        msg: |
          âœ… Test 1 BAÅARILI!
          {{ test1_result.stdout | from_json | to_nice_yaml }}

    - name: Test 2: 500 Error Testi (httpbin.org)
      debug:
        msg: "ğŸ§ª Test 2: 500 Error testi baÅŸlatÄ±lÄ±yor..."
      
    - name: 500 Error testi (retry ile)
      environment:
        API_URL: "https://httpbin.org/status/500"
        API_METHOD: "GET"
        API_AUTH_TYPE: "basic"
        API_USERNAME: "test"
        API_PASSWORD: "test"
        API_TIMEOUT: "5"
        API_MAX_RETRIES: "2"
        API_RETRY_DELAY: "2"
        API_RETRY_BACKOFF: "false"
        API_VERIFY_SSL: "true"
      command: python3 "{{ playbook_dir }}/api_request.py"
      register: test2_result
      failed_when: false  # Test baÅŸarÄ±sÄ±z olsun ama devam etsin

    - name: Test 2 sonucu
      debug:
        msg: |
          {% if test2_result.rc == 0 %}
          âœ… Test 2 - HTTP 500 Bekleniyordu (Beklenmedik baÅŸarÄ±!)
          {% else %}
          âŒ Test 2 BAÅARILI - HTTP 500 (Retry mekanizmasÄ± Ã§alÄ±ÅŸtÄ±)
          {% endif %}
          {{ test2_result.stdout | from_json | to_nice_yaml }}

    - name: Test 3: Timeout Testi (httpbin.org)
      debug:
        msg: "ğŸ§ª Test 3: Timeout testi baÅŸlatÄ±lÄ±yor..."
      
    - name: Timeout testi
      environment:
        API_URL: "https://httpbin.org/delay/3"
        API_METHOD: "GET"
        API_AUTH_TYPE: "basic"
        API_USERNAME: "test"
        API_PASSWORD: "test"
        API_TIMEOUT: "2"  # 2 saniye timeout (3 saniye bekleme var)
        API_MAX_RETRIES: "2"
        API_RETRY_DELAY: "1"
        API_RETRY_BACKOFF: "false"
        API_VERIFY_SSL: "true"
      command: python3 "{{ playbook_dir }}/api_request.py"
      register: test3_result
      failed_when: false  # Test baÅŸarÄ±sÄ±z olsun ama devam etsin

    - name: Test 3 sonucu
      debug:
        msg: |
          {% if test3_result.rc == 0 %}
          âœ… Test 3 - Timeout Bekleniyordu (Beklenmedik baÅŸarÄ±!)
          {% else %}
          âŒ Test 3 BAÅARILI - Timeout (Retry mekanizmasÄ± Ã§alÄ±ÅŸtÄ±)
          {% endif %}
          {{ test3_result.stdout | from_json | from_json | to_nice_yaml }}

    - name: Test 4: POST Testi (JSON body ile)
      debug:
        msg: "ğŸ§ª Test 4: POST isteÄŸi testi baÅŸlatÄ±lÄ±yor..."
      
    - name: POST testi
      environment:
        API_URL: "https://httpbin.org/post"
        API_METHOD: "POST"
        API_AUTH_TYPE: "basic"
        API_USERNAME: "test"
        API_PASSWORD: "test"
        API_HEADERS: '{"Content-Type": "application/json"}'
        API_DATA: '{"test": "data", "number": 123}'
        API_TIMEOUT: "10"
        API_MAX_RETRIES: "1"
        API_VERIFY_SSL: "true"
      command: python3 "{{ playbook_dir }}/api_request.py"
      register: test4_result
      failed_when: test4_result.rc not in [0]

    - name: Test 4 sonucu
      debug:
        msg: |
          âœ… Test 4 BAÅARILI!
          {{ test4_result.stdout | from_json | to_nice_yaml }}

    - name: Test SonuÃ§larÄ± Ã–zeti
      debug:
        msg: |
          ğŸ¯ TEST Ã–ZETÄ°:
          â”œâ”€ Test 1 (BaÅŸarÄ±lÄ± GET): {{ 'âœ… BAÅARILI' if test1_result.rc == 0 else 'âŒ BAÅARISIZ' }}
          â”œâ”€ Test 2 (HTTP 500): {{ 'âœ… BAÅARILI (Beklenen hata)' if test2_result.rc != 0 else 'âŒ BAÅARISIZ' }}
          â”œâ”€ Test 3 (Timeout): {{ 'âœ… BAÅARILI (Beklenen hata)' if test3_result.rc != 0 else 'âŒ BAÅARISIZ' }}
          â””â”€ Test 4 (POST): {{ 'âœ… BAÅARILI' if test4_result.rc == 0 else 'âŒ BAÅARISIZ' }}

    - name: Hata durumunda genel rapor
      fail:
        msg: |
          ğŸš« BAZI TESTLER BAÅARISIZ!
          
          Test 1 (BaÅŸarÄ±lÄ± GET): {{ 'âœ…' if test1_result.rc == 0 else 'âŒ' }}
          Test 2 (HTTP 500): {{ 'âœ…' if test2_result.rc != 0 else 'âŒ' }}
          Test 3 (Timeout): {{ 'âœ…' if test3_result.rc != 0 else 'âŒ' }}
          Test 4 (POST): {{ 'âœ…' if test4_result.rc == 0 else 'âŒ' }}
      when: test1_result.rc != 0 or test4_result.rc != 0

    - name: TÃ¼m testler baÅŸarÄ±lÄ±
      debug:
        msg: |
          ğŸ‰ TÃœM TESTLER BAÅARILI!
          
          âœ… API Client dÃ¼zgÃ¼n Ã§alÄ±ÅŸÄ±yor
          âœ… Retry mekanizmasÄ± aktif
          âœ… JSON parsing Ã§alÄ±ÅŸÄ±yor
          âœ… Authentication mekanizmasÄ± Ã§alÄ±ÅŸÄ±yor
          âœ… Hata yÃ¶netimi Ã§alÄ±ÅŸÄ±yor