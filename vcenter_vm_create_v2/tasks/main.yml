---
# Ana Task Akışı
- name: "Başlangıç Mesajı"
  ansible.builtin.debug:
    msg: "VM Oluşturma Otomasyonu Başlatılıyor - Service Desk No: {{ service_desk_no }}"

# ============================================
# ADIM 1: VM BİLGİLERİNİ BELIRLEME
# ============================================
- name: "Adım 1 - VM Bilgileri Belirleniyor"
  ansible.builtin.debug:
    msg: "Girilen parametrelere göre VM konfigürasyonu hazırlanıyor..."

# OS Type Belirleme (task parametresinden)
- name: "OS Type Belirleme - Task Parametresine Göre"
  ansible.builtin.set_fact:
    os_type: "{{ 'client' if task | lower == 'otomasyon' else 'server' }}"

- name: "Belirlenen OS Type"
  ansible.builtin.debug:
    msg: "OS Type: {{ os_type }} (Task: {{ task }})"

# Personal VM İsim Kontrolü ve Oluşturma
- name: "Personal VM mi Kontrolü"
  ansible.builtin.set_fact:
    is_personal_vm: "{{ true if (vm_name | lower == 'personal' and os_type == 'client') else false }}"

- name: "Personal VM İsim Oluşturma - Gerekli mi?"
  ansible.builtin.debug:
    msg: "{{ 'Personal VM - Otomatik isim oluşturulacak' if is_personal_vm else 'Standart VM - Girilen isim kullanılacak' }}"

# Personal VM için prefix belirleme
- name: "Personal VM Prefix ve OS Family Belirleme"
  block:
    - name: "OS Ailesi Belirleme"
      ansible.builtin.set_fact:
        temp_os_family: "{{ os_family_mapping[os] }}"

    - name: "Personal VM Prefix Belirleme"
      ansible.builtin.set_fact:
        personal_vm_prefix: "{{ 'VDI-' if temp_os_family == 'windows' else 'L-' }}{{ username | upper }}"

    - name: "Kullanılacak Prefix"
      ansible.builtin.debug:
        msg: "Personal VM Prefix: {{ personal_vm_prefix }} (OS Family: {{ temp_os_family }})"

  when: is_personal_vm | bool

# Personal VM için uygun isim bulma (Preflight + Loop)
- name: "Personal VM - Uygun İsim Bulma (Preflight + AD/vCenter Check)"
  ansible.builtin.include_tasks: find_personal_vm_name.yml
  when: is_personal_vm | bool

# Eğer personal değilse vm_name'i kullan
- name: "Final VM Adını Belirle"
  ansible.builtin.set_fact:
    final_vm_name: "{{ found_vm_name if is_personal_vm else vm_name }}"

- name: "Kullanılacak VM Adı"
  ansible.builtin.debug:
    msg: "Final VM Adı: {{ final_vm_name }}{{ ' (Personal - Index: ' + found_index | string + ')' if is_personal_vm else '' }}"

# vCenter Seçimi
- name: "vCenter Seçimi - Yerleşke ve Domain Bazlı"
  ansible.builtin.set_fact:
    selected_vcenter_name: "{{ vcenter_mapping[yerleske][domain] }}"

- name: "Seçilen vCenter Bilgileri"
  ansible.builtin.set_fact:
    selected_vcenter: "{{ vcenter_servers[selected_vcenter_name] }}"

- name: "Datacenter Konfigürasyonu Belirleme"
  ansible.builtin.set_fact:
    selected_datacenter_config: "{{ datacenter_config[yerleske] }}"

- name: "Network Adapter Belirleme (OS Type Bazlı)"
  ansible.builtin.set_fact:
    selected_network: "{{ selected_datacenter_config.networks.client if os_type == 'client' else selected_datacenter_config.networks.server }}"

- name: "VM Folder Belirleme (OS Type Bazlı)"
  ansible.builtin.set_fact:
    selected_folder: "{{ selected_datacenter_config.datacenter_path }}/{{ selected_datacenter_config.folders.clients if os_type == 'client' else selected_datacenter_config.folders.servers }}"

- name: "VM Spec Belirleme"
  ansible.builtin.set_fact:
    vm_cpu: "{{ vm_specs[vm_spec].cpu }}"
    vm_memory: "{{ vm_specs[vm_spec].memory_mb }}"
    vm_disk: "{{ vm_specs[vm_spec].disk_gb }}"

- name: "OS Template Belirleme"
  ansible.builtin.set_fact:
    vm_template: "{{ os_templates[os] }}"
    vm_guest_id: "{{ vm_settings.guest_id_mapping[os] }}"

- name: "OS Ailesi Belirleme (Windows/Linux)"
  ansible.builtin.set_fact:
    os_family: "{{ os_family_mapping[os] }}"

- name: "Network Konfigürasyon Tipi Belirleme"
  ansible.builtin.set_fact:
    network_type: "{{ 'dhcp' if os_type == 'client' else 'static' }}"

- name: "Static IP Belirleme (Eğer Server ise)"
  ansible.builtin.set_fact:
    vm_ip_address: "{{ task }}"
  when: os_type == 'server'

- name: "Domain Join Gereksinimi Kontrolü"
  ansible.builtin.set_fact:
    requires_domain_join: "{{ true if os_family == 'windows' else false }}"

- name: "OU Path Belirleme (Windows için)"
  ansible.builtin.set_fact:
    target_ou: "{{ domain_info[domain].ou_path if os_type == 'server' else domain_info[domain].ou_path_client }}"
  when: requires_domain_join | bool

- name: "Belirlenen VM Parametreleri - Özet"
  ansible.builtin.debug:
    msg:
      - "VM Adı: {{ final_vm_name }}{{ ' (Personal VM - Otomatik Oluşturuldu)' if is_personal_vm else '' }}"
      - "vCenter: {{ selected_vcenter_name }} ({{ selected_vcenter.hostname }})"
      - "Datacenter: {{ selected_datacenter_config.datacenter_name }}"
      - "Cluster: {{ selected_datacenter_config.cluster }}"
      - "Folder: {{ selected_folder }}"
      - "Network: {{ selected_network }}"
      - "Template: {{ vm_template }}"
      - "CPU: {{ vm_cpu }}"
      - "Memory: {{ vm_memory }} MB"
      - "Disk: {{ vm_disk }} GB"
      - "OS Family: {{ os_family }}"
      - "OS Type: {{ os_type }}"
      - "Network Type: {{ network_type }}"
      - "Domain Join: {{ requires_domain_join }}"
      - "Service Desk No: {{ service_desk_no }}"
      - "Requested By: {{ username }}"

# ============================================
# SONRAKI ADIMA HAZIRLIK
# ============================================
- name: "Sonraki Adıma Hazırlık"
  ansible.builtin.set_fact:
    vm_checks_passed: true
    vm_creation_config:
      name: "{{ final_vm_name }}"
      original_name: "{{ vm_name }}"
      is_personal: "{{ is_personal_vm }}"
      vcenter: "{{ selected_vcenter }}"
      vcenter_name: "{{ selected_vcenter_name }}"
      datacenter: "{{ selected_datacenter_config.datacenter_name }}"
      datacenter_path: "{{ selected_datacenter_config.datacenter_path }}"
      cluster: "{{ selected_datacenter_config.cluster }}"
      folder: "{{ selected_folder }}"
      network: "{{ selected_network }}"
      template: "{{ vm_template }}"
      guest_id: "{{ vm_guest_id }}"
      cpu: "{{ vm_cpu }}"
      memory_mb: "{{ vm_memory }}"
      disk_gb: "{{ vm_disk }}"
      os_family: "{{ os_family }}"
      os_type: "{{ os_type }}"
      network_type: "{{ network_type }}"
      requires_domain_join: "{{ requires_domain_join }}"
      target_ou: "{{ target_ou | default('') }}"
      service_desk_no: "{{ service_desk_no }}"
      requested_by: "{{ username }}"
